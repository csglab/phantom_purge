---
title: "Phantom Purge"
subtitle: "Analysis workflow for `r commandArgs(trailingOnly=T)[1]` data"
author: "Rick Farouni"
date: '`r format(Sys.Date(), "%Y-%B-%d")`'
output:
  html_notebook:
    df_print: paged
    code_folding: show
    toc: no
    toc_float: 
      collapsed: false
      smooth_scroll: false
---


# Prepare analysis workflow

### Set parameters

```{r setup}
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file(),
                     fig.width=15,
                     digit=5,
                     scipen=8)
options(digits=5, 
        scipen=8,
        future.globals.maxSize = +Inf)
```


### Set filepaths

```{r}
dataset_name <- commandArgs(trailingOnly=T)[1]
#dataset_name <- "hiseq4000"
message(sprintf("Dataset name: %s", dataset_name))
```


```{r}
project_dir <- rprojroot::find_rstudio_root_file()

if(is.null(project_dir)){
  project_dir <- getwd()
  warning(sprintf("No rstudio project root file  found. 
                  Setting project directory to current workflow.Rmd file location: %s. 
                  Override if needed.",
                  project_dir))
 
}
message(sprintf("Project directory: %s",
                project_dir))
```

### Load libraries


```{r message=FALSE, warning=FALSE}
#library(DropletUtils)
library(tidyverse)
library(matrixStats)
library(broom)
library(furrr)
library(tictoc)
library(data.table)
library(cowplot)
library(rhdf5)
plan(multiprocess)
```

### Load functions


```{r message=FALSE}
code_dir <- file.path(project_dir, "code")
source(file.path(code_dir, "analysis_functions.R"))
source(file.path(code_dir, "io_functions.R"))
source(file.path(code_dir, "workflow_functions.R"))
source(file.path(code_dir, "plotting_functions.R"))
```


# Run workflow


Estimate the sample index hopping probability, infer the true sample of origin, and find the optimal posterior probability threshold for retaining predicted real molecules.


```{r}
max_fpr <- NULL # manually set the maximum false positive rate (not recommended)
data_list <- run_workflow(dataset_name, 
                          project_dir, 
                          max_fpr=max_fpr)
```


# Show workflow output

## 1. Tranforming data and computing summary statistics

### Read counts datatable

```{r}
data_list$read_counts 
```


### Summary statistics of the joined read counts datatable

```{r}
 data_list$reads_dist_summary$summary_stats
```


### Summary statistics conditional on the PCR duplication level *r*

```{r}
 data_list$reads_dist_summary$conditional
```


###  The molecular proportions complexity profile

```{r}
 data_list$pi_r_hat
```


### The molecular proportions complexity profile plot 

```{r fig.height=9, fig.width=15, message=FALSE, warning=FALSE}
p_read <- plot_molecules_distributions(data_list, dataset_name, x_lim=120)
plot_grid(p_read$p, 
          p_read$legend,
          ncol=2,
          rel_widths=c(1, 0.1))
```


### Outcome counts datatable

```{r }
data_list$outcome_counts
```



### Chimera counts datatable


```{r}
data_list$fit_out$chimera_counts
```

## 2. Estimating the sample index hopping rate (*SIHR*)


### GLM fit estimates

```{r}
data_list$fit_out$glm_estimates
```

### Model fit plot 

```{r fig.height=9, fig.width=15, message=FALSE, warning=FALSE}
p_fit <- plot_fit(data_list, dataset_name)

plot_grid(p_fit$p,
          p_fit$legend,
          ncol=2,
          rel_widths=c(1, 0.2))
```


## 3. Purging phantom molecules


### The optimal cutoff for minimizing the false positive rate

```{r}
data_list$optimal_cutoff
```


### Plot of the empirical CDF of *qs* 



```{r fig.height=9, fig.width=15, message=FALSE, warning=FALSE}
p_post <-plot_posterior_prob(data_list, dataset_name)
plot_grid(p_post$p,
          p_post$legend,
          ncol=2,
          rel_widths=c(1, 0.1))
```

Note that *q* is the marginal posterior distribution of predicted sample of origin **s** and *qs* is a tranformation of *q*.

## 4. Examining the consequences of index hopping 

First we examing the extent of the effects of index hopping on individual samples and then on cell-barcodes.

### Tally of predicted phantoms by sample

Here *r_a* is the number of molecules above the optimal cutoff q, which we predict as real molecules. *r_a* are the number of molecules below or equal to cutoff and thus we predict as phantoms. *f* is the number of molecules predicted as phantom no matter what the threshold is. *m* is the number of total molecules. 

```{r}
data_list$reads_dist_summary$marginal
```

### Tally of predicted phantoms in called cells 

The called cells were determined from the unpurged data in order to show the level of contamination by phantom molecules if data were not purged.

```{r}
data_list$reads_dist_summary$marginal_called_cells
```


### Tally of barcodes by concordance between purged and unpurged data

```{r}
data_list$called_cells_tally
```

### Table of called cell-barcodes with the highest number of phantoms

```{r}
data_list$umi_counts_cell %>% 
  map(list("called_cells"))
```

### Table of background cell-barcodes with highest number of phantoms

```{r}
data_list$umi_counts_cell %>% 
  map(list("background_cells"))
```



# Session Info

```{r}
# memory usage
gc()
```

```{r}
sessionInfo()
```
